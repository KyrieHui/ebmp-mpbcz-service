### 1.1 预下单
#### 1.1.2 预下单接口
|接口协议|http/http+json|
|----|----|
|接口描述|支付中心根据开放银行上送的信息，调用交易创建接口，创建成功的订单编号返回给开放银行|

#### 1.1.2.1 接口方法：excute
##### 1.1.2.1.1 方法说明
拉起收银台前需进行预下单，拿到支付订单号。

##### 1.1.2.1.2 输入说明
|序号|字段名称|中文含义|类型|长度|是否必输|数据项说明|
|----|----|----|----|----|----|----|
|1|merchtOrdrId|商户订单编号|String|64|是| |
|2|bizTxTm|业务交易时间|String|14|是|yyyyMMddhhmmss|
|3|merchtId|商户号|String|64|是| |
|4|merchtNm|商户名称|String|64|否| |
|5|secMerchtId|二级商户编号|String|64|否|暂时用不到，预留|
|6|contrMerchtId|签约商户编号|String|32|否|他行卡消费，需要上送签约商户号，目前暂定为商户号|
|7|contrMerchtNm|签约商户名称|String|64|否| |
|8|usrId|用户编号|String|64|是| |
|9|usrIpAdr|用户ip|String|32|否| |
|10|ordrValidPrdDt|订单有效期|String|20|是|yyyyMMddhhmmss|
|11|ccy|币种|String|3|是|156|
|12|orgnlPrc|原价|Decimal|20,2|是| |
|13|prcAmt|售价|Decimal|20,2|否|售价现金部分，（开发时如果需要，空，就取原价）|
|14|pointPrcCnt|积分售价数量|Integer||否|售价积分|
|15|costPrc|成本价|Decimal|20,2|是| |
|16|payTotlAmt|支付总金额|Decimal|20,2|是| |
|16-1|extRightsAmt|外部权益金额|Decimal|20,2|否|外部优惠信息，中台记录不处理|
|17|bizTpCd|业务类型编码|String|32|是|决策主键|
|18|evtCd|事件编码|String|32|是|决策主键|
|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|List<decisInf>开始：决策信息组（支付决策规则基础扩展信息）|
|17|decisExtInd|决策扩展标识|String|64|否|MAP的KEY|
|18|decisExtInf|决策扩展内容|String|128|否|MAP的VALUE|
|List<decisInf>结束|List<decisInf>结束|List<decisInf>结束|List<decisInf>结束|List<decisInf>结束|List<decisInf>结束|List<decisInf>结束|
|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|List<merchdInf>开始：商品信息数组|
|19|merchdId|商品编号|String|64|否| |
|20|merchdNm|商品名称|String|128|否| |
|21|merchdCnt|商品数量|String|16|否| |
|22|merchdOrgnlPrc|商品原价|Decimal|20,2|否| |
|23|merchdCostPrc|商品成本价|Decimal|20,2|否| |
|24|merchdPrefrPrc|商品优惠价|Decimal|20,2|否| |
|List<merchdInf>结束|List<merchdInf>结束|List<merchdInf>结束|List<merchdInf>结束|List<merchdInf>结束|List<merchdInf>结束|List<merchdInf>结束|
|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|List<prefrCpnInf>开始：优惠券信息|
|25|rightsId|权益ID|String|64|否|权益ID等同于满100减20这类劵，那么是否需要传权益明细ID（具体劵编号）|
|26|rightsDtlId|权益明细ID|String|64|否|主键|
|27|rightsNm|权益名称|String|300|否| |
|28|rightsAmt|权益金额|Decimal|20,2|否| |
|List<prefrCpnInf>结束|List<prefrCpnInf>结束|List<prefrCpnInf>结束|List<prefrCpnInf>结束|List<prefrCpnInf>结束|List<prefrCpnInf>结束|List<prefrCpnInf>结束|
|List<point>开始:积分信息组|List<point>开始:积分信息组|List<point>开始:积分信息组|List<point>开始:积分信息组|List<point>开始:积分信息组|List<point>开始:积分信息组|List<point>开始:积分信息组|
|29|sumPointId|汇总积分编号|String|64|否| |
|30|pointCnt|积分数量|Integer||否| |
|List<point>结束:积分信息组|List<point>结束:积分信息组|List<point>结束:积分信息组|List<point>结束:积分信息组|List<point>结束:积分信息组|List<point>结束:积分信息组|List<point>结束:积分信息组|
|37|ordrRmrk|订单备注|String|32|否| |
|38|rtnAdr|回调地址|String|256|是|用于收银台关闭后回跳商户页面|
|39|advsAdr|通知地址|String|256|否|支付结果通知，固定地址，不需要上送|
|40|payrCpln|付款方姓名|String|32|否| |
|41|payrCertTpCd|付款方证件类型|String|2|否|01 身份证  |
|42|payrCertNo|付款方证件号|String|32|否| |
|43|payrMoblNo|付款方手机号|String|11|否| |
|44|payrMailNo|付款方邮箱|String|32|否| |

##### 1.1.2.1.3 输出
|序号|字段名称|中文含义|类型|长度|必输|数据项说明|
|----|----|----|----|----|----|----|
|1|payOrdrId|支付订单编号|String|64|是|bpaas交易创建接口返回的字段，如果成功，则将该字段返回给端，如果失败，该值为空。|
##### 1.1.2.1.4 执行逻辑
1. 接收请求后，必输数据项的校验，必输项没有输入报错【错误码：MPBCZ00000XXX,XXX不能为空（明确到每个笔数字段的校验）】。
2. 取请求中的供应商平台编号组包请求调用用户中心服务【供应商基本信息详情查询】，查询回供应商详细信息，如果返回信息为空，支付中心报错【错误码：MPBCZ0000137, 供应商平台[XXXX]信息不存在】，如果调用报错直接将异常信息抛出到端，继续判断返回供应商平台信息的状态，如果不为启用状态，支付中心报错【错误码：MPBCZ0000088, [XXXX]供应商平台鉴权不通过，状态关闭】。
3. 取请求中的用户编号组包请求调用用户中心服务【客户信息查询】, 查询用户信息，如果返回信息为空，支付中心报错【错误码：MPBCZ0000214, 用户信息不存在】，如果调用报错直接将异常信息抛出到端，继续判断用户状态，如果不为开启状态，支付中心报错【错误码：MPBCZ0000089, 用户[XXXX]鉴权未通过】，继续判用户等级，如果等级不大于等于V3，支付中心报错【错误码：MPBCZ0000090, 用户等级[XX]不支持当前操作】。
4. 取请求里的用户编号查询收银台支付白名单（t_pay_white_user）是否存在有效的数据：不存在：继续下一流程；存在组包调用账户中心【已加挂卡列表信息查询】,得到用户所有已加挂卡的列表信息，统计但会列表信息里是有存在本行借记实体卡，存在：继续下一流程；不存在：查询供应商平台支付控制表（t_pay_provr_ctrl），判断是否阻断纯他行卡用户交易：阻断、null：支付中心报错【错误码：MPBCZ0000252, 请绑定本行实体借记卡】；不阻断：根据支付金额分开判断处理，判断是否阻断：阻断、null：支付中心报错【错误码：MPBCZ0000252, 请绑定本行实体借记卡】；不阻断：判断是否需要控制笔数：不控制、null：继续；控制：取用户收银支付交易累计表（t_pay_user_tx_count）里配置区间内的交易笔数，超过阻断交易支付中心报错【错误码：MPBCZ0000252, 请绑定本行实体借记卡】；不超过：继续。判端是否控制成本价：不控制、null：继续；控制：比较交易成本价是否超过配置成本价：超过阻断交易支付中心报错【错误码：MPBCZ0000252, 请绑定本行实体借记卡】；不超过：继续。
5. 调用安全中心【安全认证工具获取】查询用户是有有支付密码，如果安全中心报错或返回NULL，支付中心报错【错误码：MPBCZ0000091, 支付密码未开通，请先开通支付密码】。
6. 根据供应商平台编号查询支付中心供应商与支付决策关系表（t_pay_provr_decision_rule）的配置信息，如果查询不到，支付中心报错【错误码：MPBCZ0000032, 供应商平台[XXXX]未配置支付决策规则】，查询到继续判断配置状态，如果不为开启状态，支付中心报错【错误码：MPBCZ0000033,供应商平台[XXXX]关联支付决策规则配置已关闭】。
7. 根据配置的支付决策规则编号查询查询支付中心支付决策规则基础表(t_pay_decision_rule) 的配置信息，如果查询不到，支付中心报错【错误码：MPBCZ0000035, 供应商平台[XXXX]关联】，查询到继续支付决策规则状态，如果不为开启状态，支付中心报错【错误码：MPBCZ0000035,支付决策规则状态不为开启】。
8. 判断请求数据中是否存在积分信息组，如果存在取积分汇总编号调用积分中心服务【汇总积分定义详情查询】查询汇总定义详细信息，如果积分中心报错，积分中心报错抛出，根据返回信息积分定义规则，计算请求中积分信息组积分抵扣金额总和，判断积分是否空耗，如果成本价<支付金额+权益金额，支付中心报错【错误码：MPBCZ0000216, 不能溢价销售】，如果成本价=支付金额+权益金额，积分就空耗，如果成本价>支付金额+权益金额,积分不空耗，但要校验积分抵扣金额是否大于差额（成本价-支付金额-权益金额）,大于时支付中心报错【错误码：MPBCZ0000215, 积分不能部分空耗】，如果小于差额，则需要计算银行垫款金额：成本价-支付金额-权益金额-积分金额。
9. 如果不存在积分信息，判断是否溢价销售，成本价<支付金额+权益金额，支付中心报错【错误码：MPBCZ0000216, 目前不支持溢价销售】。如果成本价>支付金额+权益金额，则需要计算银行垫款金额：成本价-支付金额-权益金额。
10. 根据请求数据组装入表数据，主交易信息入支付中心预下单表（t_prepay_order），商品信息入预下单商品信息表（t_prepay_merchd_inf），积分信息组入预下单积分信息表（t_prepay_point_inf），权益信息入预下单权益信息表（t_prepay_rights_inf）。
11. 组装交易创建请求数据，用户积分、用户权益、银行垫款通过扩展信息rights信息组进行透传核销，调用支付服务--【创建交易订单】-- 创建支付单信息，返回支付订单号，如果报错，异常直接抛出到调用方，成功后把支付订单号出入预下单表（t_prepay_order）。
12. 返回开发银行支付订单号，开放银行根据返回订单号，组装收银台URL地址返回第三方商城。

##### 1.1.2.1.5 外部调用服务
|外部系统|接口类型|接口名称|
|----|----|----|
|用户中心|http|供应商基本信息详情查询<br/>用户信息查询|
|积分中心|http|汇总积分定义详情查询|
|安全中心|http|安全认证工具获取|

##### 1.1.2.1.6 外部调用服务详情

### 商户查询详情

| A | B | C | D |
|:-----|:----------|:-----|:-----------------------|
| 服务名称 | 供应商信息详情查询 | 服务标识 | merchtDetailsQryFacade |
| 服务描述 |  |  |  |
| 服务框架 | REST |  |  |
| 服务地址 | /ebmp/mpur/MerchtDetailsQryFacade/v1.0.0 |  |  |
| 输入参数 |  |  |  |
| 参数编码 | 参数名称 | 参数类型 | 是否必输 |
| 输出参数 |  |  |  |
| merchtId | 商户编号 | java.lang.String | 否 |
|  |  |  |  |
| listMerchtStoreInf | 门店信息列表 | java.util.List | 否 |
| distance | 当前门店距离 | java.lang.String | 否 |
| storeSt | 门店状态 | java.lang.String | 否 |
| merchtAcctNm | 商户账户名称 | java.lang.String | 否 |
| merchtAcct | 商户账户 | java.lang.String | 否 |
| merchtAcctBankCgy | 商户账户银行类别 | java.lang.String | 否 |
| bizEndTm | 营业结束时间 | java.lang.String | 否 |
| storeAdr | 门店地址 | java.lang.String | 否 |
| bizStartTm | 营业开始时间 | java.lang.String | 否 |
| storeCarslPicAdr | 商户轮播图片地址 | java.lang.String | 否 |
| contrNm | 负责人名称 | java.lang.String | 否 |
| merchtStoreLttd | 商户门店纬度 | java.lang.String | 否 |
| merchtStoreLgtd | 商户门店经度 | java.lang.String | 否 |
| score | 评分 | java.lang.String | 否 |
| perAvgAmt | 人均金额 | java.math.BigDecimal | 否 |
| merchtStoreSynps | 商户门店简介 | java.lang.String | 否 |
| merchtStoreLogAdr | 商户门店LOG地址 | java.lang.String | 否 |
| merchtStoreNm | 商户门店名称 | java.lang.String | 否 |
| merchtStoreId | 商户门店编号 | java.lang.String | 否 |
| merchtSmlClsCd | 商户小类 | java.lang.String | 否 |
| regnId | 区编号 | java.lang.String | 否 |
| cityId | 市编号 | java.lang.String | 否 |
| provId | 省编号 | java.lang.String | 否 |
| merchtId | 商户编号 | java.lang.String | 否 |
| moblNo | 手机号码 | java.lang.String | 否 |
| listMerchtOprrInf | 门店操作员信息列表 | java.util.List | 否 |
| oprrStCd | 操作员状态 | java.lang.String | 否 |
| prvlgCd | 操作员操作权限 | java.lang.String | 否 |
| oprrContMoblNo | 操作员联系手机号 | java.lang.String | 否 |
| merchtStoreId | 商户门店编号 | java.lang.String | 否 |
| oprrAlias | 操作员别名 | java.lang.String | 否 |
| merchtId | 商户编号 | java.lang.String | 否 |
| oprrNm | 操作员名称 | java.lang.String | 否 |
| certNo | 证件号码 | java.lang.String | 否 |
| usrId | 用户编号 | java.lang.String | 否 |
| listMerchtImptPrsnInf | 商户重要人员信息列表 | java.util.List | 否 |
| cpln | 姓名 | java.lang.String | 否 |
| pos | 职务 | java.lang.String | 否 |
| merchtId | 商户编号 | java.lang.String | 否 |
| certNo | 证件号码 | java.lang.String | 否 |
| certTp | 证件类型 | java.lang.String | 否 |
| merchtStCd | 商户状态代码 | java.lang.String | 否 |
| belgOrgNm | 归属机构名称 | java.lang.String | 否 |
| belgOrgId | 归属机构编号 | java.lang.String | 否 |
| stopDt | 截止日期 | java.util.Date | 否 |
| campPrsnNm | 营销人名称 | java.lang.String | 否 |
| campPrsnId | 营销人编号 | java.lang.String | 否 |
| merchtAcctNm | 商户账户名称 | java.lang.String | 否 |
| merchtAcct | 商户账户 | java.lang.String | 否 |
| merchtAcctBankCgy | 商户账户银行类别 | java.lang.String | 否 |
| merchtSynps | 商户简介 | java.lang.String | 否 |
| merchtCarslPicAdr | 商户轮播图片地址1 | java.lang.String | 否 |
| merchtAdr | 商户地址 | java.lang.String | 否 |
| regnId | 区编号 | java.lang.String | 否 |
| cityId | 市编号 | java.lang.String | 否 |
| provId | 省编号 | java.lang.String | 否 |
| contrMail | 联系人邮箱 | java.lang.String | 否 |
| moblNo | 手机号码 | java.lang.String | 否 |
| contrNm | 负责人名称 | java.lang.String | 否 |
| merchtLogoAdr | 商户LOGO图地址 | java.lang.String | 否 |
| corpCertNo | 企业证件号码 | java.lang.String | 否 |
| corpCertTp | 企业证件类型 | java.lang.String | 否 |
| merchtId | 商户编号 | java.lang.String | 否 |
| merchtShtNm | 商户简称 | java.lang.String | 否 |
| merchtNm | 商户名称 | java.lang.String | 否 |
| merchtClCd | 商户分类代码 | java.lang.String | 否 |
| merchtSmlClsCd | 商户小类 | java.lang.String | 否 |
| merchtBigClsCd | 商户大类代码 | java.lang.String | 否 |

---

### 用户基本信息查询

| A | B | C | D |
|:-----|:---------|:-----|:---------------------|
| 服务名称 | 用户基本信息查询 | 服务标识 | usrBasicInfQryFacade |
| 服务描述 |  |  |  |
| 服务框架 | REST |  |  |
| 服务地址 | /ebmp/mpur/UsrBasicInfQryFacade/v1.0.0 |  |  |
| 输入参数 |  |  |  |
| 参数编码 | 参数名称 | 参数类型 | 是否必输 |
| 输出参数 |  |  |  |
| usrId | 用户编号 | java.lang.String | 否 |
|  |  |  |  |
| oblgInfDsc | 预留信息 | java.lang.String | 否 |
| hdstAdr | 用户IndvUsrOpenAcctURL | java.lang.String | 否 |
| nickNm | 用户昵称 | java.lang.String | 否 |
| idCardExpireSt | 身份证过期状态 | java.lang.String | 否 |
| elmntSt | 九要素状态 | java.lang.String | 否 |
| lvlIndCd | 等级标识 | java.lang.String | 否 |
| listIndvUsrCertInf | 用户证件类型列表 | java.util.List | 否 |
| mainCertFlg | 主证件标志 | java.lang.String | 否 |
| certTpCd | 证件类型2 | java.lang.String | 否 |
| certNo | 证件号码 | java.lang.String | 否 |
| moblNo | 手机号码 | java.lang.String | 否 |
| usrAtteLvlCd | 用户认证等级代码 | java.lang.String | 否 |
| usrStCd | 用户状态代码 | java.lang.String | 否 |
| usrId | 用户编号 | java.lang.String | 否 |

---

### 认证工具查询

| A | B | C | D |
|:-----|:-----------|:-----|:-----------------------|
| 服务名称 | 用户交易认证工具查询 | 服务标识 | indvUsrTxAtteQryFacade |
| 服务描述 |  |  |  |
| 服务框架 | REST |  |  |
| 服务地址 | /ebmp/mpsr/IndvUsrTxAtteQryFacade/v1.0.0 |  |  |
| 输入参数 |  |  |  |
| 参数编码 | 参数名称 | 参数类型 | 是否必输 |
|  |  |  |  |
| usrId | 用户编号 | java.lang.String | 否 |
| openSt | 开通状态 | java.lang.String | 否 |
| 输出参数 |  |  |  |
| listIndvTransAtte | 个人开通交易认证方式查询 | java.util.List | 否 |
| openTm | 开通时间 | java.lang.String | 否 |
| openSt | 开通状态 | java.lang.String | 否 |
| openChnl | 开通渠道 | java.lang.String | 否 |
| atteMth | 认证方式 | java.lang.String | 否 |

---

### 积分汇总信息查询

| A | B | C | D | E |
|:-----|:------------|:-----|:----------------------------|:-|
| 服务名称 | 汇总积分_汇总积分查询 | 服务标识 | pointSumConfigInfoListPages |  |
| 服务描述 |  |  |  |  |
| 服务框架 | REST |  |  |  |
| 服务地址 | /ebmp/mpbcj/PointSumConfigInfoListPages/v1.0.0 |  |  |  |
| 输入参数 |  |  |  |  |
| 参数编码 | 参数名称 | 参数类型 | 是否必输 | 备注 |
| apprvStCd | 审批状态代码 | java.lang.String | 否 | 00有效、01待生效、02待审批、03待停用、04已停用/无效、05待更新 |
| sumPointNm | 汇总积分名称 | java.lang.String | 否 | 汇总积分名称 |
| pointTpCd | 积分类型编码 | java.lang.String | 否 | 积分类型编码 |
| pointStCd | 积分状态编码 | java.lang.String | 否 | 积分状态编码 |
| cretId | 创建人2 | java.lang.String | 否 |  |
| cretTm | 创建时间2 | java.lang.String | 否 |  |
| pageSize | 分页大小 | java.lang.String | 否 |  |
| endTm | 结束时间 | java.util.Date | 否 |  |
| pageIndex | 页码 | java.lang.String | 否 |  |
| belgOrgId | 归属机构编号 | java.lang.String | 否 |  |
| usrTpCd | 用户类型代码 | java.lang.String | 否 | 用户类型代码 |
| 输出参数 |  |  |  |  |
| pageSize | 分页大小 | java.lang.String | 否 |  |
| pageIndex | 页码 | java.lang.String | 否 |  |
| listPointPages | 汇总积分列表 | java.util.List | 否 | 汇总积分列表 |
| belgOrgId | 归属机构编号 | java.lang.String | 否 |  |
| modiId | 修改人2 | java.lang.String | 否 |  |
| cretTm | 创建时间2 | java.lang.String | 否 |  |
| cretId | 创建人2 | java.lang.String | 否 |  |
| modiTm | 修改时间 | java.util.Date | 否 |  |
| canEditFlg | 可编辑标志 | java.lang.String | 否 | 可编辑标志 |
| pointRglPrcCnt | 积分定价数量 | java.lang.Integer | 否 | 积分定价数量 |
| canRecallFlg | 可撤销标志 | java.lang.Integer | 否 | 可撤销标志 |
| canDelFlg | 可删除标志 | java.lang.Integer | 否 | 可删除标志 |
| flwId | 流程编号 | java.lang.String | 否 | 流程编号 |
| orgnlSumPointNm | 原汇总积分名称 | java.lang.String | 否 | 原汇总积分名称 |
| orgnlSumPointId | 原汇总积分编号 | java.lang.String | 否 | 原汇总积分编号 |
| modiOrgId | 修改人机构编号 | java.lang.String | 否 | 修改人机构编号 |
| cretOrgId | 创建人机构编号 | java.lang.String | 否 | 创建人机构编号 |
| pointRglPrcAmt | 积分定价金额 | java.math.BigDecimal | 否 | 积分定价金额 |
| pointRglPrcUnitCd | 积分定价单位编码 | java.lang.String | 否 | 积分定价单位编码 |
| suitOrgZoneId | 使用机构地区编号 | java.lang.String | 否 | 使用机构地区编号 |
| suitOrgZoneTpCd | 适用机构地区类型编码 | java.lang.String | 否 | 适用机构地区类型编码 |
| pointStCd | 积分状态编码 | java.lang.String | 否 | 积分状态编码 |
| pointTpCd | 积分类型编码 | java.lang.String | 否 | 积分类型编码 |
| sumPointNm | 汇总积分名称 | java.lang.String | 否 | 汇总积分名称 |
| sumPointId | 汇总积分编号 | java.lang.String | 否 | 汇总积分编号 |
| apprvStCd | 审批状态代码 | java.lang.String | 否 | 00有效、01待生效、02待审批、03待停用、04已停用/无效、05待更新 |
| usrTpCd | 用户类型代码 | java.lang.String | 否 | 用户类型代码 |
| useChnlCd | 使用渠道代码 | java.lang.String | 否 | 使用渠道代码 |
| modiNm | 修改人名称 | java.lang.String | 否 | 修改人名称 |

##### 1.1.2.1.7 相关数据库表
|英文表名|中文表名|描述|
|----|----|----|
|t_prepay_order|预下单表|其他平台接入收银台，预下单主要支付信息数据|
|t_prepay_merchd_inf|预下单商品信息表|其他平台接入收银台，预下单购买的商品信息数据|
|t_prepay_point_inf|预下单积分信息表|其他平台接入收银台，预下单用的用户积分信息数据|
|t_prepay_rights_inf|预下单权益信息表|其他平台接入收银台，预下单使用的用户权益信息数据|
|t_pay_provr_decision_rule|供应商与支付决策关系表|供应商平台关联的支付决策规则|
|t_pay_decision_rule|支付决策规则基础表|支付决策规则的基本配置信息，主要是业务类型和事件码，状态|